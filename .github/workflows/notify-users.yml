name: Notify All Stargazers
on: [push]  # Or use `schedule` to reduce spam

jobs:
  ping:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
    - name: Fetch All Stargazers & Notify
      uses: actions/github-script@v7
      with:
        script: |
          // Function to fetch all stargazers (handle multiple pages)
          async function getAllStargazers() {
            let page = 1;
            const per_page = 100; // max allowed
            let allUsers = [];
            while (true) {
              const res = await github.rest.activity.listStargazersForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page,
                page
              });
              if (res.data.length === 0) break;
              allUsers = allUsers.concat(res.data.map(u => `@${u.login}`));
              page++;
            }
            return allUsers;
          }

          const users = await getAllStargazers();
          if (users.length === 0) {
            console.log("No stargazers yet!");
            return;
          }

          const mentionText = users.join(' ');

          // Check if an issue "Stargazers Notification" already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });

          const existing = issues.data.find(i => i.title === "Stargazers Notification");

          if (existing) {
            // Update the existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existing.number,
              body: `Hello community!\n\nLive stats from TML-Database: https://stats.tennismylife.org/\n\n**Feel free to link it in your projects!**\n\n${mentionText}\n\n#tennis #stats #TML`
            });
            console.log("Issue updated:", existing.html_url);
          } else {
            // Create a new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Stargazers Notification",
              body: `Hello community!\n\nLive stats from TML-Database: https://stats.tennismylife.org/\n\n**Feel free to link it in your projects!**\n\n${mentionText}\n\n#tennis #stats #TML`,
              labels: ['promotion']
            });
            console.log("Issue created:", issue.data.html_url);
          }
